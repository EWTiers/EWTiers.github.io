<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>E…¥·¥† èW·¥è Ä ü·¥Ö-T…™·¥á Äs</title>
  <link rel="icon" type="image/png" href="favicon.png">
  <link rel="stylesheet" href="style.css"/>
  <style>
    body {
      background: url('ezzzzz.png') no-repeat center center fixed, #181818;
      background-size: cover;
    }
    .game-tab-content { display:none; }
    .game-tab-content.active { display:block; }
  </style>
</head>
<body>
  <div class="top-left-info">
    <span class="server-address" id="copy-address">play.envyworld.gg</span>
  </div>
  <div class="top-right-controls">
    <span id="auth-indicator"><span class="dot"></span> –ì–æ—Å—Ç—å</span>
    <button id="auth-btn" onclick="showAuthModal()">–í–æ–π—Ç–∏</button>
  </div>
  <div id="auth-modal" class="modal" style="display:none">
    <div class="modal-content">
      <h2><span class="lock-ico">üîí</span>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è</h2>
      <input type="password" id="auth-password" placeholder="–ü–∞—Ä–æ–ª—å"/>
      <button id="auth-enter-btn" onclick="checkPassword()">–í–æ–π—Ç–∏</button>
      <div id="auth-error" class="error-message"></div>
    </div>
  </div>

  <div class="container">
    <header>
        <h1>
        <img src="sword1.gif" alt="–ù–µ–∑–µ—Ä–∏—Ç–æ–≤—ã–π –º–µ—á" style="height:1.3em;vertical-align:middle;margin-right:10px;">
        –¢–∏—Ä-–ª–∏—Å—Ç –∏–≥—Ä–æ–∫–æ–≤
        <img src="sword.gif" alt="–ê–ª–º–∞–∑–Ω—ã–π –º–µ—á" style="height:1.3em;vertical-align:middle;margin-left:10px;transform:scaleX(-1);">
        </h1>
      <div class="game-modes" style="display:flex;justify-content:center;gap:12px;">
        <button id="kitpvp-btn" class="mode-btn active" onclick="switchGameTab('kitpvp')">KitPVP</button>
        <button id="nezerpot-btn" class="mode-btn" onclick="switchGameTab('nezerpot')">NethPot</button>
      </div>
    </header>
    <div class="game-tab-content active" id="tierlist-kitpvp">
      <div class="tier-container">
        <div class="tier tier-1"><div class="tier-header"><span class="tier-label">Tier 1</span></div><div class="players-list" id="kitpvp-tier1"></div></div>
        <div class="tier tier-2"><div class="tier-header"><span class="tier-label">Tier 2</span></div><div class="players-list" id="kitpvp-tier2"></div></div>
        <div class="tier tier-3"><div class="tier-header"><span class="tier-label">Tier 3</span></div><div class="players-list" id="kitpvp-tier3"></div></div>
        <div class="tier tier-4"><div class="tier-header"><span class="tier-label">Tier 4</span></div><div class="players-list" id="kitpvp-tier4"></div></div>
        <div class="tier tier-5"><div class="tier-header"><span class="tier-label">Tier 5</span></div><div class="players-list" id="kitpvp-tier5"></div></div>
      </div>
      <div id="kitpvp-form" class="admin-only-form" style="display:none;">
        <select id="kitpvp-player-type" class="player-type-select">
          <option value="high">High</option>
          <option value="low">Low</option>
        </select>
        <input id="kitpvp-player-name" class="player-input" placeholder="–ò–º—è –∏–≥—Ä–æ–∫–∞"/>
        <select id="kitpvp-player-tier" class="player-select">
          <option value="1">Tier 1</option>
          <option value="2">Tier 2</option>
          <option value="3">Tier 3</option>
          <option value="4">Tier 4</option>
          <option value="5">Tier 5</option>
        </select>
        <button id="kitpvp-add-btn" onclick="addPlayer('kitpvp')">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>
    <div class="game-tab-content" id="tierlist-nezerpot">
      <div class="tier-container">
        <div class="tier tier-1"><div class="tier-header"><span class="tier-label">Tier 1</span></div><div class="players-list" id="nezerpot-tier1"></div></div>
        <div class="tier tier-2"><div class="tier-header"><span class="tier-label">Tier 2</span></div><div class="players-list" id="nezerpot-tier2"></div></div>
        <div class="tier tier-3"><div class="tier-header"><span class="tier-label">Tier 3</span></div><div class="players-list" id="nezerpot-tier3"></div></div>
        <div class="tier tier-4"><div class="tier-header"><span class="tier-label">Tier 4</span></div><div class="players-list" id="nezerpot-tier4"></div></div>
        <div class="tier tier-5"><div class="tier-header"><span class="tier-label">Tier 5</span></div><div class="players-list" id="nezerpot-tier5"></div></div>
      </div>
      <div id="nezerpot-form" class="admin-only-form" style="display:none;">
        <select id="nezerpot-player-type" class="player-type-select">
          <option value="high">High</option>
          <option value="low">Low</option>
        </select>
        <input id="nezerpot-player-name" class="player-input" placeholder="–ò–º—è –∏–≥—Ä–æ–∫–∞"/>
        <select id="nezerpot-player-tier" class="player-select">
          <option value="1">Tier 1</option>
          <option value="2">Tier 2</option>
          <option value="3">Tier 3</option>
          <option value="4">Tier 4</option>
          <option value="5">Tier 5</option>
        </select>
        <button id="nezerpot-add-btn" onclick="addPlayer('nezerpot')">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";
const firebaseConfig = {
  apiKey: "AIzaSyAXz5odCHUE3-guCR-a3KcxWYINK2fgZD4",
  authDomain: "ewtiers.firebaseapp.com",
  projectId: "ewtiers",
  storageBucket: "ewtiers.appspot.com",
  messagingSenderId: "3653761892",
  appId: "1:3653761892:web:432b3b7922fd693c291871",
  measurementId: "G-Z5JF67WQ8K"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const ADMIN_PASSWORD_HASH = "240be518fabd2724ddb6f04eeb1da5967448d7e831c08c8fa822809f74c720a9";
let isAdmin = false;
if (localStorage.getItem('isAdmin') === '1') isAdmin = true;
let currentTab = 'kitpvp';
let playersKitpvpLast = [];
let playersNezerpotLast = [];

let draggedName = null, draggedFromTier = null, draggedType = null, draggedId = null;

function updateAddForms() {
  document.getElementById('kitpvp-form').style.display = isAdmin ? '' : 'none';
  document.getElementById('nezerpot-form').style.display = isAdmin ? '' : 'none';
}
function updateAuthUI() {
  document.getElementById('auth-indicator').innerHTML =
    isAdmin ? '<span class="dot" style="background:#4ecdc4"></span> –ê–¥–º–∏–Ω' : '<span class="dot"></span> –ì–æ—Å—Ç—å';
  document.getElementById('auth-btn').textContent = isAdmin ? '–í—ã–π—Ç–∏' : '–í–æ–π—Ç–∏';
  document.getElementById('auth-btn').onclick = isAdmin ? logout : showAuthModal;
}
function switchGameTab(tab) {
  if(tab === currentTab) return;
  document.getElementById('tierlist-' + currentTab).classList.remove('active');
  document.getElementById(tab + '-btn').classList.add('active');
  document.getElementById(currentTab + '-btn').classList.remove('active');
  document.getElementById('tierlist-' + tab).classList.add('active');
  currentTab = tab;
  if (tab === 'kitpvp') render('kitpvp', playersKitpvpLast);
  else if (tab === 'nezerpot') render('nezerpot', playersNezerpotLast);
}

window.switchGameTab = switchGameTab;

function subscribePlayers(tab, callback) {
  onSnapshot(collection(db, tab), (snapshot) => {
    console.log('[firestore] subscribe snapshot for tab:', tab, 'size:', snapshot.size);
    let obj = {"1":[], "2":[], "3":[], "4":[], "5":[]};
    snapshot.forEach(docSnap => {
      const d = docSnap.data();
      let t = (typeof d.tier === "string") ? d.tier : d.tier.toString();
      obj[t] && obj[t].push({name:d.name, type:d.type, id:docSnap.id});
    });
    let playersByTier = [undefined, obj["1"], obj["2"], obj["3"], obj["4"], obj["5"]];
    console.log('[firestore] result by tier', tab, playersByTier);
    callback(playersByTier);
  });
}

async function addPlayerToBase(tab, name, tier, type) {
  await addDoc(collection(db, tab), { name, tier, type });
}
async function deletePlayerFromBase(tab, id) {
  await deleteDoc(doc(db, tab, id));
}
function render(tab, playersTab) {
  for(let tier=1;tier<=5;tier++) {
    let pArr = playersTab[tier] || [];
    document.getElementById(tab + '-tier' + tier).innerHTML = (pArr || []).filter(p => p && p.name)
    .map(p =>
      `<div class="player ${p.type}-tier" draggable="${isAdmin}" data-name="${p.name}" data-type="${p.type}" data-id="${p.id}" >
        ${p.type === 'high' ? 'HT' : 'LT'} | ${p.name}
      </div>`
    ).join('');
  }
  updateAddForms();
  updateAuthUI();
  enableDnD(tab, playersTab);
  disableDnDForGuests();
  document.body.classList.toggle('admin-mode', isAdmin);
}
function enableDnD(tab, playersTab) {
  let droppedInTier = false;
  document.querySelectorAll('.player').forEach(playerEl => {
    playerEl.setAttribute('draggable', isAdmin ? 'true' : 'false');
    playerEl.ondragstart = null;
    playerEl.ondragend = null;
  });
  document.querySelectorAll('.players-list').forEach(listEl=>{
    listEl.ondragover = null;
    listEl.ondrop = null;
    listEl.ondragenter = null;
    listEl.ondragleave = null;
    listEl.parentNode.classList.remove('drag-over');
  });
  document.body.ondragover = null;
  document.body.ondrop = null;
  if (!isAdmin) return;
  document.querySelectorAll('.player').forEach(playerEl => {
    playerEl.ondragstart = function(e) {
      draggedName = this.getAttribute('data-name');
      draggedType = this.getAttribute('data-type');
      draggedId = this.getAttribute('data-id');
      let matchTier = this.parentElement.id.match(/(kitpvp|nezerpot)-tier(\d)/);
      if (matchTier) draggedFromTier = [matchTier[1], matchTier[2]];
      setTimeout(()=>{ this.classList.add('dragging'); },0);
      droppedInTier = false;
    };
    playerEl.ondragend = function(e) {
      this.classList.remove('dragging');
      if (draggedName && draggedType && draggedFromTier && !droppedInTier) {
        let [tab, tier] = draggedFromTier;
        if (draggedId) deletePlayerFromBase(tab, draggedId);
      }
      draggedName = null; draggedType = null; draggedFromTier = null; draggedId = null; droppedInTier = false;
    };
  });
  document.querySelectorAll('.players-list').forEach(listEl=>{
    listEl.ondragover = function(e) {
      e.preventDefault();
      if (!isAdmin) return;
      this.parentNode.classList.add('drag-over');
    };
    listEl.ondragleave = function(e) {
      this.parentNode.classList.remove('drag-over');
    };
    listEl.ondrop = function(e) {
      e.preventDefault();
      this.parentNode.classList.remove('drag-over');
      droppedInTier = true;
      if (!draggedName || !draggedType || !draggedFromTier) return;
      let matchTo = this.id.match(/(kitpvp|nezerpot)-tier(\d)/);
      let toTab = matchTo[1], toTier = matchTo[2];
      let [fromTab, fromTier] = draggedFromTier;
      if (toTab !== fromTab) return;
      if (fromTier === toTier) return;
      if (draggedId) deletePlayerFromBase(toTab, draggedId);
      addPlayerToBase(toTab, draggedName, toTier, draggedType);
    }
  });
  document.body.ondragover = function(e){ e.preventDefault(); };
  document.body.ondrop = function(e) {
    if (!e.target.closest('.tier')) droppedInTier = false;
  };
}
function disableDnDForGuests() {
  if (!isAdmin) {
    document.querySelectorAll('.player').forEach(playerEl => {
      playerEl.removeAttribute('draggable');
      playerEl.ondragstart = null;
      playerEl.ondragend = null;
    });
    document.querySelectorAll('.players-list').forEach(listEl=>{
      listEl.ondragover = null;
      listEl.ondrop = null;
      listEl.ondragenter = null;
      listEl.ondragleave = null;
      listEl.parentNode.classList.remove('drag-over');
    });
    document.body.ondragover = null;
    document.body.ondrop = null;
  }
}
window.addPlayer = function(tab) {
  if (!isAdmin) return;
  let name = document.getElementById(tab+'-player-name').value.trim();
  let tier = document.getElementById(tab+'-player-tier').value;
  let type = document.getElementById(tab+'-player-type').value;
  if(!name) return;
  addPlayerToBase(tab, name, tier, type);
  document.getElementById(tab+'-player-name').value = '';
};
window.checkPassword = async function() {
  const pass = document.getElementById('auth-password').value;
  const hash = await hashPassword(pass);
  if(hash === ADMIN_PASSWORD_HASH) {
    isAdmin = true;
    localStorage.setItem('isAdmin', '1');
    document.getElementById('auth-modal').style.display = 'none';
    updateAddForms(); updateAuthUI();
  } else {
    document.getElementById('auth-error').textContent = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å";
  }
};
function logout() {
  isAdmin = false;
  localStorage.removeItem('isAdmin');
  updateAddForms(); updateAuthUI();
}
window.logout = logout;
window.showAuthModal = function() {
  document.getElementById('auth-modal').style.display = 'flex';
  document.getElementById('auth-password').value = "";
  document.getElementById('auth-error').textContent = "";
};
async function hashPassword(password) {
  const encoder = new TextEncoder();
  const data = encoder.encode(password);
  const hash = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
}
document.addEventListener('click', function(e) {
  if (e.target === document.getElementById('auth-modal'))
    document.getElementById('auth-modal').style.display = "none";
});
document.addEventListener('keydown', function(e) {
  if (
    document.getElementById('auth-modal').style.display !== "none" &&
    (e.key === "Enter" || e.keyCode === 13)
  ) {
    checkPassword();
  }
});
document.addEventListener('DOMContentLoaded', function() {
  subscribePlayers('kitpvp', function(playersKitpvp) {
    playersKitpvpLast = playersKitpvp;
    if (currentTab === 'kitpvp') render('kitpvp', playersKitpvp);
  });
  subscribePlayers('nezerpot', function(playersNezerpot) {
    playersNezerpotLast = playersNezerpot;
    if (currentTab === 'nezerpot') render('nezerpot', playersNezerpot);
  });

  const address = document.getElementById('copy-address');
  if(address) {
    address.addEventListener('click', function() {
      navigator.clipboard.writeText(address.textContent);
      address.textContent = "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!";
      setTimeout(() => address.textContent = "play.envyworld.gg", 1200);
    });
  }
  document.body.addEventListener('click', function(e) {
    if (e.target.classList.contains('player')) {
      const name = e.target.getAttribute('data-name');
      if (name) {
        navigator.clipboard.writeText(name);
      }
    }
  });
});

</script>
</body>
</html>
